# Migration Guide

<!-- markdownlint-configure-file { "ol-prefix": 0 } -->

We are improving Detox API as we go along, sometimes these changes require us to break the API in order for it to make more sense. These migration guides refer to breaking changes. If a newer version has no entries in this document, it means it does not require special migration steps. Refer to the release notes of the latter builds to learn about their improvements and changes.

## 20.0

### No [Mocha] support

If you were using Mocha, now you have two options:

- switch to [Jest] using [`detox init`] boilerplate as a reference and [`testRunner` config];
- wait until a third-party integration with Mocha appears.

### Jest 27.2.5 and higher

You have to upgrade your Jest version to at least 27.2.5 or higher. The recommended choice is 28.x or 29.x.

### All-in-one configs

If you see an error like this:

```plain text
DetoxConfigError: Configuration "legacy" uses a deprecated all-in-one schema,
      "build": "...",
      "launchArgs": {}
    }
  }
}
```

  </td>
  <td>

```json
{
  "apps": {
    "ios.debug": {
      "type": "ios.app",
      "binaryPath": "/some/path/ios.app",
      "build": "..."
    },
    "android.debug": {
      "type": "android.apk",
      "binaryPath": "/some/path/android.apk",
      "build": "...",
      "launchArgs": {}
    }
  },
  "devices": {
    "ios.simulator": {
      "type": "ios.simulator",
      "device": { "type": "iPhone 12" }
    },
    "android.emulator": {
      "type": "android.apk",
      "device": { "avdName": "Pixel_30_API" }
    }
  },
  "configurations": {
    "ios.sim.debug": {
      "device": "ios.simulator",
      "app": "ios.debug"
    },
    "android.emu.debug": {
      "device": "android.emulator",
      "app": "android.debug"
    }
  }
}
```

  </td>
</tr>
</table>

For more details refer to the [`Config > Devices`](../config/devices.mdx) and [`Config > Apps`](../config/apps.mdx) sections.

### `testRunner` config section

Three top-level string properties (`testRunner`, `runnerConfig`, `specs`) have been unified into a complex
`testRunner` section which strives to be as agnostic as possible:

```diff title=".detoxrc.js"
-  testRunner: 'jest',
-  runnerConfig: 'e2e/jest.config.js',
-  specs: 'e2e',
-  skipLegacyWorkersInjection: true,
+  testRunner: {
+    $0: 'jest',
+    args: {
+      config: 'e2e/jest.config.js',
+      _: ['e2e']
+    },
+  },
```

Also, `skipLegacyWorkersInjection` migration option no longer has meaning, so you can remove it safely.

If you didn’t have `runnerConfig` previously, use `e2e/config.json` (because that was an implicit default
in Detox 19 and earlier):

```diff
  testRunner: {
    $0: 'jest',
    args: {
+     config: 'e2e/config.json',
    },
 },
```

### Custom Jest environment

You no longer need to have an autogenerated environment file if you haven’t been customizing it,
and if it looks like below:

```js title="e2e/environment.js"
const {
  DetoxCircusEnvironment,
  SpecReporter,
  WorkerAssignReporter,
} = require('detox/runners/jest-circus');

class CustomDetoxEnvironment extends DetoxCircusEnvironment {
  constructor(config, context) {
    super(config, context);

    // Can be safely removed, if you are content with the default value (=300000ms)
    this.initTimeout = 300000;

    // This takes care of generating status logs on a per-spec basis. By default, Jest only reports at file-level.
    // This is strictly optional.
    this.registerListeners({
      SpecReporter,
      WorkerAssignReporter,
    });
  }
}

module.exports = CustomDetoxEnvironment;
```

If you want, for example:

- to reduce the init timeout to 120 seconds,
- remove `SpecReporter` output,
- remove `WorkerAssignReporter` output,

then you can express this intent via config:

```js title=".detoxrc.js"
/** @type {Detox.DetoxConfig} */
module.exports = {
  testRunner: {
    $0: 'jest',
    args: {
      config: 'e2e/jest.config.js',
      _: ['e2e']
    },
// highlight-start
    jest: {
      setupTimeout: 120000,
      reportSpecs: false,
      reportWorkerAssign: false,
    },
// highlight-end
  },
  // …
};
```

If you have some customizations beyond that, make sure to remove the boilerplate code:

```js title="e2e/environment.js"
// highlight-next-line
const { DetoxCircusEnvironment } = require('detox/runners/jest');

class CustomDetoxEnvironment extends DetoxCircusEnvironment {
  constructor(config, context) {
    super(config, context);

    // leave your custom code
  }
}

module.exports = CustomDetoxEnvironment;
```

Pay attention that the import has been changed to `detox/runners/jest` (previously it was `detox/runners/jest-circus`),
and the reporters (`SpecReporter`, `WorkerAssignReporter`) are no longer exported. You can continue using
`this.initTimeout` if you rename it there to `this.setupTimeout`, but you can also delegate that to Detox config like shown earlier.

### New Jest config

Let's examine **the old configs** first to see what needs to be removed or changed:

```js showLineNumbers title="e2e/jest.config.js"
module.exports = {
  maxWorkers: 1,
  testEnvironment: './environment',
  testRunner: 'jest-circus/runner',
  testTimeout: 120000,
  testRegex: '\\.e2e\\.js$',
  reporters: ['detox/runners/jest/streamlineReporter'],
  verbose: true
};
```

See comments line by line:

1\. As a recommendation, switch to CommonJS (`module.exports = {}`) instead of JSON, if you haven’t done that already.

2\. If you don’t have `maxWorkers: 1` configured, please add it.

3\. If you removed your test environment in the previous step, remove the `testEnvironment` property.

4\. Remove `testRunner` since it is already `jest-circus` by default in Jest 27.x and higher.

5\. You need a long `testTimeout` value, because usually end-to-end tests cannot complete in 5 seconds, which is
Jest's default timeout value. We suggest 120 seconds by default, but you can fine-tine it.

6\. We recommend to use `rootDir` and `testMatch` instead of `testRegex`, like this (assuming your Jest config is
in `e2e` folder of your project, together with the Detox test files):

```diff
-  testRegex: '',
+  rootDir: '..',
+  testMatch: ['<rootDir>/e2e/**/*.test.js'],
```

7\. Remove that `streamlineReporter`. You’ll be adding a new reporter in a second.

8\. You need to set `verbose: true` to disable log batching. In other words, Jest will be printing
logs with a significant delay, which is just inconvenient and annoying when you need
to know what exactly is happening right now.

Now, let's take a look at **the new config** and the required additions:

```js showLineNumbers title="e2e/jest.config.js"
module.exports = {
  maxWorkers: 1,
  testTimeout: 120000,
  verbose: true,
// highlight-start
  reporters: ['detox/runners/jest/reporter'],
  globalSetup: 'detox/runners/jest/globalSetup',
  globalTeardown: 'detox/runners/jest/globalTeardown',
  testEnvironment: 'detox/runners/jest/testEnvironment',
// highlight-end
};
```

Let's focus on lines 5-8:

5. Add the new Detox reporter as the first one to your existing `reporters: [...]` array or create that property
   like we show. It is a reserved reporter for Detox core logic, so it does not affect your logs or any other output –
   just make sure you have it.

